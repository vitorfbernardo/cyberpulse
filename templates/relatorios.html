{% extends "base.html" %}

{% block title %}Relatórios - CyberPulse{% endblock %}

{% block content %}
<div class="reports-container">
    <!-- Cabeçalho -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-chart-bar"></i> Relatórios e Estatísticas</h1>
            <p>Análise completa das notícias de cybersecurity</p>
        </div>
    </div>

    <!-- Estatísticas Gerais -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-details">
                <span class="stat-value">{{ total_news }}</span>
                <span class="stat-label">Total de Notícias</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-details">
                <span class="stat-value">{{ last_30_days }}</span>
                <span class="stat-label">Últimos 30 Dias</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="stat-details">
                <span class="stat-value">{{ categories_stats|length }}</span>
                <span class="stat-label">Categorias</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-rss"></i>
            </div>
            <div class="stat-details">
                <span class="stat-value">{{ sources_stats|length }}</span>
                <span class="stat-label">Fontes Ativas</span>
            </div>
        </div>
    </div>

    <!-- Gráficos Interativos -->
    <div class="charts-section">
        <div class="section-header">
            <h2><i class="fas fa-chart-line"></i> Análise Visual Interativa</h2>
        </div>

        <!-- Gráfico de Linha - Evolução -->
        <div class="chart-card">
            <h3><i class="fas fa-chart-line"></i> Evolução de Notícias (Últimos 30 dias)</h3>
            <canvas id="lineChart"></canvas>
        </div>

        <!-- Gráficos lado a lado -->
        <div class="charts-grid">
            <!-- Gráfico de Pizza - Categorias -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> Distribuição por Categoria</h3>
                <canvas id="pieChart"></canvas>
            </div>

            <!-- Gráfico de Barras - Fontes -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-bar"></i> Notícias por Fonte</h3>
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Distribuição por Categoria -->
    <div class="report-section">
        <div class="section-header">
            <h2><i class="fas fa-chart-pie"></i> Distribuição por Categoria</h2>
        </div>
        <div class="category-chart">
            {% for cat in categories_stats %}
            <div class="category-bar-item">
                <div class="category-info">
                    <span class="category-name">{{ cat.name }}</span>
                    <span class="category-percentage">{{ cat.percentage|floatformat:1 }}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ cat.percentage }}%"></div>
                </div>
                <span class="category-count">{{ cat.count }} notícias</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Distribuição por Fonte -->
    <div class="report-section">
        <div class="section-header">
            <h2><i class="fas fa-rss-square"></i> Distribuição por Fonte</h2>
        </div>
        <div class="sources-grid">
            {% for source in sources_stats %}
            <div class="source-card">
                <div class="source-header">
                    <span class="source-icon"><i class="fas fa-newspaper"></i></span>
                    <span class="source-name">{{ source.name }}</span>
                </div>
                <div class="source-stats">
                    <div class="source-count">{{ source.count }}</div>
                    <div class="source-label">notícias</div>
                </div>
                <div class="source-percentage-bar">
                    <div class="percentage-fill" style="width: {{ source.percentage }}%"></div>
                </div>
                <div class="source-percentage-text">{{ source.percentage|floatformat:1 }}% do total</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Detalhamento por Categoria -->
    <div class="report-section">
        <div class="section-header">
            <h2><i class="fas fa-list-ul"></i> Detalhamento Completo</h2>
        </div>
        <div class="detail-table-wrapper">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Quantidade</th>
                        <th>Percentual</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat in categories_stats %}
                    <tr>
                        <td>
                            <span class="table-category">{{ cat.name }}</span>
                        </td>
                        <td><strong>{{ cat.count }}</strong></td>
                        <td>
                            <div class="mini-bar">
                                <div class="mini-fill" style="width: {{ cat.percentage }}%"></div>
                                <span class="mini-text">{{ cat.percentage|floatformat:1 }}%</span>
                            </div>
                        </td>
                        <td>
                            {% if cat.percentage > 30 %}
                                <span class="status-badge high">Alto Volume</span>
                            {% elif cat.percentage > 15 %}
                                <span class="status-badge medium">Médio Volume</span>
                            {% else %}
                                <span class="status-badge low">Baixo Volume</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ações de Exportação -->
    <div class="export-section">
        <h3><i class="fas fa-download"></i> Exportar Relatório</h3>
        <div class="export-buttons">
            <button class="export-btn pdf">
                <i class="fas fa-file-pdf"></i> Exportar como PDF
            </button>
            <button class="export-btn excel">
                <i class="fas fa-file-excel"></i> Exportar como Excel
            </button>
            <button class="export-btn csv">
                <i class="fas fa-file-csv"></i> Exportar como CSV
            </button>
        </div>
        <p class="export-note">
            <i class="fas fa-info-circle"></i> Os botões de exportação serão implementados em versão futura
        </p>
    </div>
</div>

<style>
    .reports-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: rgba(20, 25, 30, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 12px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: var(--cyber-green);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, var(--cyber-green), var(--cyber-blue));
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: var(--cyber-dark);
    }

    .stat-details {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--cyber-green);
        line-height: 1;
    }

    .stat-label {
        color: #aaaaaa;
        font-size: 0.95rem;
    }

    /* Seção de Gráficos */
    .charts-section {
        background: rgba(20, 25, 30, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.1);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: rgba(10, 15, 20, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
    }

    .chart-card h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        color: var(--cyber-green);
        font-size: 1.2rem;
    }

    .chart-card canvas {
        max-height: 400px;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
    }

    .charts-grid .chart-card canvas {
        max-height: 350px;
    }

    .report-section {
        background: rgba(20, 25, 30, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.1);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .section-header {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(0, 255, 136, 0.2);
    }

    .section-header h2 {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--cyber-green);
        font-size: 1.5rem;
    }

    .category-chart {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .category-bar-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .category-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .category-name {
        font-weight: 600;
        color: #ffffff;
    }

    .category-percentage {
        color: var(--cyber-green);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .progress-bar {
        height: 30px;
        background: rgba(10, 15, 20, 0.8);
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid rgba(0, 255, 136, 0.2);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--cyber-green), var(--cyber-blue));
        transition: width 1s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
    }

    .category-count {
        color: #888888;
        font-size: 0.9rem;
        text-align: right;
    }

    .sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .source-card {
        background: rgba(10, 15, 20, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 10px;
        padding: 25px;
        transition: all 0.3s ease;
    }

    .source-card:hover {
        border-color: var(--cyber-green);
        transform: translateY(-5px);
    }

    .source-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .source-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--cyber-green), var(--cyber-blue));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--cyber-dark);
    }

    .source-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .source-stats {
        text-align: center;
        margin-bottom: 15px;
    }

    .source-count {
        font-size: 3rem;
        font-weight: 800;
        color: var(--cyber-green);
        line-height: 1;
    }

    .source-label {
        color: #aaaaaa;
        font-size: 0.9rem;
    }

    .source-percentage-bar {
        height: 8px;
        background: rgba(10, 15, 20, 0.8);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .percentage-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--cyber-green), var(--cyber-blue));
        transition: width 1s ease;
    }

    .source-percentage-text {
        text-align: center;
        color: #888888;
        font-size: 0.9rem;
    }

    .detail-table-wrapper {
        overflow-x: auto;
    }

    .detail-table {
        width: 100%;
        border-collapse: collapse;
    }

    .detail-table thead {
        background: rgba(10, 15, 20, 0.9);
    }

    .detail-table th {
        padding: 15px;
        text-align: left;
        color: var(--cyber-green);
        font-weight: 600;
        border-bottom: 2px solid rgba(0, 255, 136, 0.3);
    }

    .detail-table td {
        padding: 15px;
        border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    }

    .detail-table tr:hover {
        background: rgba(0, 255, 136, 0.05);
    }

    .table-category {
        font-weight: 600;
    }

    .mini-bar {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mini-fill {
        height: 20px;
        background: linear-gradient(90deg, var(--cyber-green), var(--cyber-blue));
        border-radius: 10px;
        min-width: 30px;
    }

    .mini-text {
        font-weight: 600;
        color: var(--cyber-green);
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-badge.high {
        background: rgba(255, 100, 0, 0.2);
        color: #ff6600;
        border: 1px solid rgba(255, 100, 0, 0.3);
    }

    .status-badge.medium {
        background: rgba(255, 255, 0, 0.2);
        color: #ffff00;
        border: 1px solid rgba(255, 255, 0, 0.3);
    }

    .status-badge.low {
        background: rgba(0, 255, 136, 0.2);
        color: var(--cyber-green);
        border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .export-section {
        background: rgba(20, 25, 30, 0.8);
        border: 1px solid rgba(0, 255, 136, 0.1);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
    }

    .export-section h3 {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: var(--cyber-green);
        margin-bottom: 25px;
        font-size: 1.3rem;
    }

    .export-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .export-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .export-btn.pdf {
        background: linear-gradient(135deg, #ff3333, #ff6600);
        color: #ffffff;
    }

    .export-btn.excel {
        background: linear-gradient(135deg, #00aa00, #00dd00);
        color: #ffffff;
    }

    .export-btn.csv {
        background: linear-gradient(135deg, var(--cyber-green), var(--cyber-blue));
        color: var(--cyber-dark);
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4);
    }

    .export-note {
        color: #888888;
        font-size: 0.9rem;
        font-style: italic;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* Responsividade */
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-overview {
            grid-template-columns: 1fr;
        }

        .sources-grid {
            grid-template-columns: 1fr;
        }

        .export-buttons {
            flex-direction: column;
        }

        .export-btn {
            width: 100%;
            justify-content: center;
        }

        .chart-card {
            padding: 15px;
        }

        .chart-card canvas {
            max-height: 300px;
        }
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Configuração de cores do tema cyber
const cyberGreen = 'rgba(0, 255, 136, 0.8)';
const cyberBlue = 'rgba(0, 204, 255, 0.8)';
const cyberYellow = 'rgba(255, 255, 0, 0.8)';
const cyberRed = 'rgba(255, 50, 50, 0.8)';
const cyberPurple = 'rgba(255, 0, 255, 0.8)';
const cyberOrange = 'rgba(255, 100, 0, 0.8)';

// Gráfico de Linha - Evolução
const lineCtx = document.getElementById('lineChart');
if (lineCtx) {
    const lineChart = new Chart(lineCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ dates_list|safe }},
            datasets: [{
                label: 'Notícias por Dia',
                data: {{ counts_list|safe }},
                borderColor: cyberGreen,
                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: cyberGreen,
                pointBorderColor: '#0a0f14',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(10, 15, 20, 0.95)',
                    titleColor: cyberGreen,
                    bodyColor: '#ffffff',
                    borderColor: cyberGreen,
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return 'Notícias: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            size: 12
                        },
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(0, 255, 136, 0.1)',
                        borderColor: 'rgba(0, 255, 136, 0.2)'
                    }
                },
                x: {
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            size: 11
                        },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        color: 'rgba(0, 255, 136, 0.05)',
                        borderColor: 'rgba(0, 255, 136, 0.2)'
                    }
                }
            }
        }
    });
}

// Gráfico de Pizza - Categorias
const pieCtx = document.getElementById('pieChart');
if (pieCtx) {
    const pieChart = new Chart(pieCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                label: 'Categorias',
                data: {{ category_counts|safe }},
                backgroundColor: [
                    cyberRed,
                    cyberOrange,
                    cyberPurple,
                    cyberBlue,
                    cyberGreen,
                    cyberYellow
                ],
                borderColor: '#0a0f14',
                borderWidth: 3,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        font: {
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(10, 15, 20, 0.95)',
                    titleColor: cyberGreen,
                    bodyColor: '#ffffff',
                    borderColor: cyberGreen,
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Barras - Fontes
const barCtx = document.getElementById('barChart');
if (barCtx) {
    const barChart = new Chart(barCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ source_labels|safe }},
            datasets: [{
                label: 'Notícias por Fonte',
                data: {{ source_counts|safe }},
                backgroundColor: [
                    cyberGreen,
                    cyberBlue,
                    cyberOrange
                ],
                borderColor: [
                    cyberGreen,
                    cyberBlue,
                    cyberOrange
                ],
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: [
                    'rgba(0, 255, 136, 1)',
                    'rgba(0, 204, 255, 1)',
                    'rgba(255, 100, 0, 1)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(10, 15, 20, 0.95)',
                    titleColor: cyberGreen,
                    bodyColor: '#ffffff',
                    borderColor: cyberGreen,
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Notícias: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            size: 12
                        },
                        stepSize: 5
                    },
                    grid: {
                        color: 'rgba(0, 255, 136, 0.1)',
                        borderColor: 'rgba(0, 255, 136, 0.2)'
                    }
                },
                x: {
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        display: false,
                        borderColor: 'rgba(0, 255, 136, 0.2)'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}