{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - CyberPulse{% endblock %}

{% block content %}
<div class="dashboard-powerbi">
    
    <!-- HEADER -->
    <div class="dashboard-header">
        <div>
            <h1><i class="fas fa-chart-line"></i> Dashboard CyberPulse</h1>
            <p>Monitoramento em tempo real de not√≠cias de cybersecurity</p>
        </div>
        <div class="last-update">
            <i class="fas fa-sync-alt"></i>
            Atualizado agora
        </div>
    </div>

    <!-- ROW 1: KPIs PRINCIPAIS -->
    <div class="kpi-row">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">{{ total_news }}</div>
                <div class="kpi-label">Total de Not√≠cias</div>
            </div>
        </div>

        <div class="kpi-card kpi-danger">
            <div class="kpi-icon">
                <i class="fas fa-fire"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">{{ last_24h }}</div>
                <div class="kpi-label">√öltimas 24 Horas</div>
            </div>
        </div>

        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">{{ last_7days }}</div>
                <div class="kpi-label">√öltimos 7 Dias</div>
            </div>
        </div>

        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">{{ last_30days }}</div>
                <div class="kpi-label">√öltimos 30 Dias</div>
            </div>
        </div>
    </div>

    <!-- ROW 2: GR√ÅFICOS PRINCIPAIS -->
    <div class="charts-row">
        <!-- Gr√°fico de Pizza - Categorias -->
        <div class="chart-card">
            <div class="chart-header">
                <h3><i class="fas fa-chart-pie"></i> Distribui√ß√£o por Categoria</h3>
            </div>
            <div class="chart-body">
                <canvas id="categoriesChart"></canvas>
            </div>
        </div>

        <!-- Gr√°fico de Linha - Evolu√ß√£o -->
        <div class="chart-card">
            <div class="chart-header">
                <h3><i class="fas fa-chart-line"></i> Evolu√ß√£o Temporal (30 dias)</h3>
            </div>
            <div class="chart-body">
                <canvas id="timelineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ROW 3: TOP FONTES + NOT√çCIAS RECENTES -->
    <div class="details-row">
        <!-- Top Fontes -->
        <div class="chart-card">
            <div class="chart-header">
                <h3><i class="fas fa-globe"></i> Top 6 Fontes (clique para filtrar)</h3>
            </div>
            <div class="chart-body">
                <canvas id="sourcesChart" style="cursor: pointer;"></canvas>
            </div>
        </div>

        <!-- Not√≠cias Recentes -->
        <div class="chart-card">
            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="fas fa-clock"></i> Not√≠cias Recentes (√∫ltimos 90 dias)</h3>
                <!-- Badge de filtro ativo -->
                <div id="filterBadge" style="display: none;">
                    <span style="background: linear-gradient(135deg, #00ff88, #00ccff); 
                                 color: #0a0f14; 
                                 padding: 6px 12px; 
                                 border-radius: 20px; 
                                 font-weight: 600; 
                                 font-size: 0.75rem;
                                 display: inline-flex;
                                 align-items: center;
                                 gap: 8px;
                                 white-space: nowrap;">
                        üîç <span id="filterSource"></span>
                        <button onclick="clearFilter()" style="background: rgba(10, 15, 20, 0.5); 
                                                                border: none; 
                                                                color: #ffffff; 
                                                                border-radius: 50%; 
                                                                width: 18px; 
                                                                height: 18px; 
                                                                cursor: pointer;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                font-weight: bold;
                                                                font-size: 12px;
                                                                transition: all 0.3s ease;"
                                onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                                onmouseout="this.style.background='rgba(10,15,20,0.5)'">
                            ‚úï
                        </button>
                    </span>
                </div>
            </div>
            <div class="chart-body">
                {% if recent_news %}
                <div class="recent-news-list" id="newsContainer">
                    {% for news in recent_news %}
                    <div class="recent-news-item news-card" data-source="{{ news.source }}">
                        <span class="news-icon-small">{{ news.get_category_display_icon }}</span>
                        <div class="news-info">
                            <div class="news-title-small">{{ news.title|truncatewords:10 }}</div>
                            <div class="news-meta-small">
                                <span class="news-source-small">{{ news.source }}</span>
                                <span>‚Ä¢</span>
                                <span class="news-time-small">{{ news.published_date|timesince }} atr√°s</span>
                            </div>
                        </div>
                        <a href="{{ news.link }}" target="_blank" class="news-link-small">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>Nenhuma not√≠cia encontrada</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ROW 4: CATEGORIAS DETALHADAS -->
    <div class="categories-row">
        {% for category_name, count in categories_count.items %}
        <div class="category-card">
            <div class="category-icon-big">
                {% if "Vulnerabilidade" in category_name %}
                    üîì
                {% elif "Vazamento" in category_name %}
                    ‚ö†Ô∏è
                {% elif "Malware" in category_name %}
                    ü¶†
                {% elif "Patch" in category_name %}
                    üîß
                {% else %}
                    üì∞
                {% endif %}
            </div>
            <div class="category-value">{{ count }}</div>
            <div class="category-name-small">{{ category_name }}</div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Dados do backend
const categoriesLabels = {{ categories_labels|safe }};
const categoriesData = {{ categories_data|safe }};
const sourcesLabels = {{ sources_labels|safe }};
const sourcesData = {{ sources_data|safe }};
const timelineLabels = {{ timeline_labels|safe }};
const timelineData = {{ timeline_data|safe }};

// Cores cyberpunk
const cyberColors = {
    green: 'rgba(0, 255, 136, 0.8)',
    blue: 'rgba(0, 204, 255, 0.8)',
    purple: 'rgba(153, 0, 255, 0.8)',
    pink: 'rgba(255, 0, 136, 0.8)',
    yellow: 'rgba(255, 204, 0, 0.8)',
};

const cyberColorsBorder = {
    green: 'rgba(0, 255, 136, 1)',
    blue: 'rgba(0, 204, 255, 1)',
    purple: 'rgba(153, 0, 255, 1)',
    pink: 'rgba(255, 0, 136, 1)',
    yellow: 'rgba(255, 204, 0, 1)',
};

// Gr√°fico de Pizza - Categorias
const ctxCategories = document.getElementById('categoriesChart').getContext('2d');
new Chart(ctxCategories, {
    type: 'doughnut',
    data: {
        labels: categoriesLabels,
        datasets: [{
            data: categoriesData,
            backgroundColor: [
                cyberColors.green,
                cyberColors.blue,
                cyberColors.purple,
                cyberColors.pink,
                cyberColors.yellow,
            ],
            borderColor: [
                cyberColorsBorder.green,
                cyberColorsBorder.blue,
                cyberColorsBorder.purple,
                cyberColorsBorder.pink,
                cyberColorsBorder.yellow,
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#ffffff',
                    font: { size: 12 },
                    padding: 15
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#00ff88',
                bodyColor: '#ffffff',
                borderColor: '#00ff88',
                borderWidth: 1
            }
        }
    }
});

// Gr√°fico de Linha - Evolu√ß√£o
const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
new Chart(ctxTimeline, {
    type: 'line',
    data: {
        labels: timelineLabels,
        datasets: [{
            label: 'Not√≠cias por Dia',
            data: timelineData,
            borderColor: cyberColorsBorder.green,
            backgroundColor: 'rgba(0, 255, 136, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: cyberColors.green,
            pointBorderColor: cyberColorsBorder.green,
            pointBorderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#00ff88',
                bodyColor: '#ffffff',
                borderColor: '#00ff88',
                borderWidth: 1
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    color: '#888888',
                    font: { size: 11 }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                }
            },
            x: {
                ticks: {
                    color: '#888888',
                    font: { size: 10 },
                    maxRotation: 45,
                    minRotation: 45
                },
                grid: {
                    display: false
                }
            }
        }
    }
});

// Gr√°fico de Barras - Top Fontes (COM EVENTO DE CLIQUE)
const ctxSources = document.getElementById('sourcesChart').getContext('2d');
new Chart(ctxSources, {
    type: 'bar',
    data: {
        labels: sourcesLabels,
        datasets: [{
            label: 'Not√≠cias',
            data: sourcesData,
            backgroundColor: cyberColors.blue,
            borderColor: cyberColorsBorder.blue,
            borderWidth: 2
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        // ‚Üê ADICIONAR EVENTO DE CLIQUE AQUI
        onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
                const index = activeElements[0].index;
                const selectedSource = sourcesLabels[index];
                filterNewsBySource(selectedSource);
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#00ccff',
                bodyColor: '#ffffff',
                borderColor: '#00ccff',
                borderWidth: 1,
                callbacks: {
                    afterLabel: function() {
                        return '(clique para filtrar)';
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    color: '#888888',
                    font: { size: 11 }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                }
            },
            y: {
                ticks: {
                    color: '#888888',
                    font: { size: 11 }
                },
                grid: {
                    display: false
                }
            }
        }
    }
});

// ========================================
// FUN√á√ïES DE FILTRO
// ========================================

// Vari√°vel global para controlar filtro ativo
let activeFilter = null;

// Fun√ß√£o para filtrar not√≠cias por fonte
function filterNewsBySource(source) {
    activeFilter = source;
    
    // Pegar todos os cards de not√≠cias
    const newsCards = document.querySelectorAll('.news-card');
    
    // Mostrar badge de filtro
    document.getElementById('filterBadge').style.display = 'block';
    document.getElementById('filterSource').textContent = source;
    
    // Filtrar not√≠cias
    let visibleCount = 0;
    newsCards.forEach(card => {
        const cardSource = card.getAttribute('data-source');
        
        if (cardSource === source) {
            // Mostrar not√≠cia com anima√ß√£o
            card.style.display = 'flex';
            card.style.animation = 'fadeIn 0.4s ease';
            visibleCount++;
        } else {
            // Esconder not√≠cia
            card.style.display = 'none';
        }
    });
    
    // Se n√£o encontrar nenhuma not√≠cia da fonte
    if (visibleCount === 0) {
        showNoResultsMessage(source);
    } else {
        // Remover mensagem de "sem resultados" se existir
        const noResultsMsg = document.getElementById('noResultsMessage');
        if (noResultsMsg) {
            noResultsMsg.remove();
        }
    }
    
    // Scroll suave at√© a se√ß√£o de not√≠cias
    const newsSection = document.querySelector('.details-row');
    if (newsSection) {
        newsSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// Fun√ß√£o para limpar filtro
function clearFilter() {
    activeFilter = null;
    
    // Esconder badge
    document.getElementById('filterBadge').style.display = 'none';
    
    // Mostrar todas as not√≠cias
    const newsCards = document.querySelectorAll('.news-card');
    newsCards.forEach(card => {
        card.style.display = 'flex';
        card.style.animation = 'fadeIn 0.3s ease';
    });
    
    // Remover mensagem de "sem resultados" se existir
    const noResultsMsg = document.getElementById('noResultsMessage');
    if (noResultsMsg) {
        noResultsMsg.remove();
    }
}

// Fun√ß√£o para mostrar mensagem quando n√£o h√° not√≠cias
function showNoResultsMessage(source) {
    // Remover mensagem anterior se existir
    const existingMsg = document.getElementById('noResultsMessage');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // Criar nova mensagem
    const newsContainer = document.getElementById('newsContainer');
    if (!newsContainer) return;
    
    const message = document.createElement('div');
    message.id = 'noResultsMessage';
    message.style.cssText = `
        text-align: center;
        padding: 40px 20px;
        color: #888;
        font-size: 0.95rem;
    `;
    message.innerHTML = `
        <i class="fas fa-search" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
        <p style="margin-bottom: 15px;">Nenhuma not√≠cia encontrada de <strong style="color: var(--cyber-green);">${source}</strong></p>
        <button onclick="clearFilter()" style="
            padding: 10px 20px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border: none;
            border-radius: 8px;
            color: #0a0f14;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,255,136,0.3)'" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
            Ver todas as not√≠cias
        </button>
    `;
    
    newsContainer.appendChild(message);
}
</script>

<style>
/* === DASHBOARD POWERBI STYLE === */

.dashboard-powerbi {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

/* === HEADER === */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(20, 25, 30, 0.8);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 12px;
}

.dashboard-header h1 {
    font-size: 2rem;
    color: var(--cyber-green);
    margin-bottom: 5px;
}

.dashboard-header p {
    color: #888888;
    font-size: 0.95rem;
}

.last-update {
    color: var(--cyber-blue);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* === KPI CARDS === */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: rgba(20, 25, 30, 0.8);
    border: 2px solid;
    border-radius: 12px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
}

.kpi-card.kpi-primary { border-color: rgba(0, 255, 136, 0.5); }
.kpi-card.kpi-danger { border-color: rgba(255, 0, 136, 0.5); }
.kpi-card.kpi-warning { border-color: rgba(255, 204, 0, 0.5); }
.kpi-card.kpi-info { border-color: rgba(0, 204, 255, 0.5); }

.kpi-icon {
    font-size: 3rem;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

.kpi-primary .kpi-icon {
    background: rgba(0, 255, 136, 0.1);
    color: var(--cyber-green);
}

.kpi-danger .kpi-icon {
    background: rgba(255, 0, 136, 0.1);
    color: #ff0088;
}

.kpi-warning .kpi-icon {
    background: rgba(255, 204, 0, 0.1);
    color: #ffcc00;
}

.kpi-info .kpi-icon {
    background: rgba(0, 204, 255, 0.1);
    color: var(--cyber-blue);
}

.kpi-content {
    flex: 1;
}

.kpi-value {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 5px;
}

.kpi-primary .kpi-value { color: var(--cyber-green); }
.kpi-danger .kpi-value { color: #ff0088; }
.kpi-warning .kpi-value { color: #ffcc00; }
.kpi-info .kpi-value { color: var(--cyber-blue); }

.kpi-label {
    color: #888888;
    font-size: 0.9rem;
    font-weight: 500;
}

/* === CHARTS === */
.charts-row,
.details-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: rgba(20, 25, 30, 0.8);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 12px;
    overflow: hidden;
}

.chart-header {
    background: rgba(10, 15, 20, 0.9);
    padding: 20px;
    border-bottom: 1px solid rgba(0, 255, 136, 0.2);
}

.chart-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    color: var(--cyber-green);
}

.chart-body {
    padding: 20px;
    min-height: 300px;
    position: relative;
}

.chart-body canvas {
    max-height: 300px;
}

/* === NOT√çCIAS RECENTES === */
.recent-news-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 500px;      /* ‚Üê ADICIONAR */
    overflow-y: auto;        /* ‚Üê ADICIONAR */
    padding-right: 10px;     /* ‚Üê ADICIONAR */
}

/* Scrollbar customizada - ADICIONAR TUDO ISSO */
.recent-news-list::-webkit-scrollbar {
    width: 6px;
}

.recent-news-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.recent-news-list::-webkit-scrollbar-thumb {
    background: var(--cyber-green);
    border-radius: 10px;
}

.recent-news-list::-webkit-scrollbar-thumb:hover {
    background: var(--cyber-blue);
}

.recent-news-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.3s ease;
}

.recent-news-item:hover {
    background: rgba(0, 255, 136, 0.05);
    border-left-color: var(--cyber-green);
    transform: translateX(3px);
}

.news-icon-small {
    font-size: 1.5rem;
    min-width: 30px;
}

.news-info {
    flex: 1;
}

.news-title-small {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 5px;
    line-height: 1.3;
}

.news-meta-small {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #888888;
    font-size: 0.8rem;
}

.news-source-small {
    color: var(--cyber-blue);
    font-weight: 500;
}

.news-time-small {
    color: #666666;
}

.news-link-small {
    color: var(--cyber-green);
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.news-link-small:hover {
    color: var(--cyber-blue);
    transform: scale(1.2);
}

/* === CATEGORIAS DETALHADAS === */
.categories-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

.category-card {
    background: rgba(20, 25, 30, 0.8);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.category-card:hover {
    transform: translateY(-5px);
    border-color: var(--cyber-green);
    box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
}

.category-icon-big {
    font-size: 3rem;
    margin-bottom: 10px;
}

.category-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--cyber-green);
    margin-bottom: 5px;
}

.category-name-small {
    color: #888888;
    font-size: 0.85rem;
    font-weight: 500;
}

/* === NO DATA === */
.no-data {
    text-align: center;
    padding: 40px;
    color: #888888;
}

.no-data i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* === ANIMA√á√ÉO DE FADE IN === */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* === RESPONSIVIDADE === */
@media (max-width: 1200px) {
    .charts-row,
    .details-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }

    .kpi-row {
        grid-template-columns: 1fr;
    }

    .categories-row {
        grid-template-columns: repeat(2, 1fr);
    }

    .kpi-card {
        padding: 20px;
    }

    .kpi-icon {
        font-size: 2.5rem;
        width: 60px;
        height: 60px;
    }

    .kpi-value {
        font-size: 2rem;
    }
    
    /* Badge de filtro responsivo */
    #filterBadge span {
        font-size: 0.7rem;
        padding: 5px 10px;
    }
}
</style>
{% endblock %}